(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[18],{290:function(e,t,r){Promise.resolve().then(r.bind(r,7720))},7720:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return y}});var a=r(7437),i=r(2265),n=r(495),s=r(6013),l=r(9135),o=r(857),d=r(371),u=r(3518),c=r.n(u),p=r(1180);function m(e){let[t,r]=e;return[-67.35+t/230*2.1999999999999886,18.55-r/120*.6999999999999993]}function g(e){return e.length<3?null:{type:"Polygon",coordinates:[[...e,e[0]].map(m)]}}function f(e){let{regions:t,activeRegionId:r}=e,o=(0,p.O)(),d=(0,i.useRef)(null),u=(0,i.useRef)(null),m=(0,i.useMemo)(()=>{var e;return null!==(e=t.find(e=>e.id===r))&&void 0!==e?e:null},[t,r]),[f,_]=(0,i.useState)([]),[y,h]=(0,i.useState)("idle"),[v,x]=(0,i.useState)(!1),[b,j]=(0,i.useState)(null),S=(0,i.useMemo)(()=>m?function e(t){if(!t)return null;if("string"==typeof t){let r=t.trim();if(r.startsWith("{")&&r.endsWith("}")||r.startsWith("[")&&r.endsWith("]"))try{return e(JSON.parse(r))}catch(e){return null}return r.startsWith("M")||r.startsWith("m")?function(e){var t,r;let a=null!==(r=null===(t=e.match(/-?\d+(?:\.\d+)?/g))||void 0===t?void 0:t.map(Number))&&void 0!==r?r:[];if(a.length<6)return null;let i=[];for(let e=0;e+1<a.length;e+=2){let t=a[e],r=a[e+1];Number.isFinite(t)&&Number.isFinite(r)&&i.push([t,r])}return g(i)}(r):null}return Array.isArray(t)?t.length>=3&&Array.isArray(t[0])&&"number"==typeof t[0][0]?g(t):null:(null==t?void 0:t.type)&&Array.isArray(null==t?void 0:t.coordinates)?t:null}(m.map_polygon):null,[m]),w=(0,i.useMemo)(()=>m?{type:"FeatureCollection",features:S?[{type:"Feature",id:m.id,properties:{id:m.id,name:m.name,color:m.color},geometry:S}]:[]}:{type:"FeatureCollection",features:[]},[m,S]);(0,i.useEffect)(()=>{if(!d.current||u.current)return;let e="#ffffff",t=new(c()).Map({container:d.current,center:[-66.5,18.2],zoom:7.6,style:{version:8,sources:{},layers:[{id:"bg",type:"background",paint:{"background-color":"#d7f2ff"}}]}});return t.addControl(new(c()).NavigationControl,"top-right"),t.on("load",()=>{t.addSource("pr-label",{type:"geojson",data:{type:"FeatureCollection",features:[{type:"Feature",properties:{name:"Puerto Rico"},geometry:{type:"Point",coordinates:[-66.4,18.22]}}]}}),t.addLayer({id:"pr-label-layer",type:"symbol",source:"pr-label",layout:{"text-field":["get","name"],"text-size":22,"text-font":["Open Sans Semibold"],"text-allow-overlap":!0},paint:{"text-color":"#1a2b4a","text-halo-color":e,"text-halo-width":3}}),t.addSource("region",{type:"geojson",data:w}),t.addLayer({id:"region-fill",type:"fill",source:"region",paint:{"fill-color":["get","color"],"fill-opacity":.86}}),t.addLayer({id:"region-line-blue",type:"line",source:"region",paint:{"line-color":"#1e86d6","line-width":7,"line-opacity":.95,"line-blur":.3}}),t.addLayer({id:"region-line-white",type:"line",source:"region",paint:{"line-color":e,"line-width":3.6,"line-opacity":.95,"line-blur":.2}}),t.addSource("draft",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),t.addLayer({id:"draft-line",type:"line",source:"draft",paint:{"line-color":"#f0c15d","line-width":3,"line-opacity":.9}}),t.addLayer({id:"draft-points",type:"circle",source:"draft",paint:{"circle-radius":4,"circle-color":"#f0c15d","circle-stroke-color":"#0b0b0d","circle-stroke-width":1}})}),t.on("click",e=>{"drawing"===y&&_(t=>[...t,[e.lngLat.lng,e.lngLat.lat]])}),u.current=t,()=>{var e;null===(e=u.current)||void 0===e||e.remove(),u.current=null}},[]),(0,i.useEffect)(()=>{let e=u.current;if(!e||!e.isStyleLoaded())return;let t=e.getSource("region");if(t&&t.setData(w),S){let t=function(e){let t=1/0,r=1/0,a=-1/0,i=-1/0,n=e=>{if(!Array.isArray(e)||e.length<2)return;let[n,s]=e;"number"==typeof n&&"number"==typeof s&&(t=Math.min(t,n),r=Math.min(r,s),a=Math.max(a,n),i=Math.max(i,s))},s=e=>{if(e){if(Array.isArray(e)&&"number"==typeof e[0]){n(e);return}Array.isArray(e)&&e.forEach(s)}};return(s(e.coordinates),Number.isFinite(t)&&Number.isFinite(r)&&Number.isFinite(a)&&Number.isFinite(i))?[[t,r],[a,i]]:null}(S);t&&e.fitBounds(t,{padding:24,duration:0})}},[w,S]),(0,i.useEffect)(()=>{let e=u.current;if(!e||!e.isStyleLoaded())return;let t=e.getSource("draft");if(!t)return;let r=[];for(let e of f)r.push({type:"Feature",properties:{kind:"pt"},geometry:{type:"Point",coordinates:e}});f.length>=2&&r.push({type:"Feature",properties:{kind:"line"},geometry:{type:"LineString",coordinates:f}}),t.setData({type:"FeatureCollection",features:r})},[f]);let N=async()=>{if(!o||!m)return;if(f.length<3){j("Agrega al menos 3 puntos para crear un pol\xedgono.");return}x(!0),j(null);let e=[...f,f[0]],{error:t}=await o.from("regions").update({map_polygon:{type:"Polygon",coordinates:[e]}}).eq("id",m.id);if(x(!1),t){j("Error guardando: ".concat(t.message));return}j("Guardado. Recarga datos para ver el cambio."),h("idle"),_([])};return(0,a.jsxs)(s.Z,{title:"Editor de regiones (MapLibre)",badge:(0,a.jsx)(l.A,{children:m?m.name:"Selecciona una regi\xf3n"}),children:[(0,a.jsx)("div",{className:"du-meta",children:"Este editor guarda `regions.map_polygon` como GeoJSON (Polygon) en coordenadas [lng,lat]. Eso es lo que el mapa del jugador usa para dibujar divisiones."}),(0,a.jsx)("div",{className:"du-divider"}),(0,a.jsxs)("div",{className:"du-chip-row",style:{flexWrap:"wrap"},children:[(0,a.jsxs)(l.A,{children:["Modo: ",y]}),(0,a.jsx)(n.z,{variant:"ghost",disabled:!m,onClick:()=>{h(e=>"drawing"===e?"idle":"drawing"),j(null)},children:"drawing"===y?"Salir dibujo":"Dibujar pol\xedgono"}),(0,a.jsx)(n.z,{variant:"ghost",disabled:0===f.length,onClick:()=>{_([]),j(null)},children:"Limpiar puntos"}),(0,a.jsx)(n.z,{disabled:!m||v,onClick:N,children:v?"Guardando…":"Cerrar y guardar"})]}),b?(0,a.jsx)("div",{className:"du-meta",style:{marginTop:8},children:b}):null,(0,a.jsx)("div",{className:"du-maplibre",ref:d})]})}function _(){var e,t;let{status:r,userId:u}=(0,o.a)(),c=!!u,p=(0,d.G)(),m=(null===(e=p.profile)||void 0===e?void 0:e.role)==="admin"||(null===(t=p.profile)||void 0===t?void 0:t.is_admin),[g,_]=(0,i.useState)(null);return(0,a.jsxs)("div",{className:"du-stack",children:[(0,a.jsxs)(s.Z,{title:"Admin / Game Engine",badge:(0,a.jsx)(l.A,{children:c?"Authorized":"Sign in required"}),children:[(0,a.jsx)("p",{children:"Manage regions, creatures/stages, region_creatures, missions, achievements, trainers, and battle pass."}),(0,a.jsxs)("div",{className:"du-chip-row",children:[(0,a.jsx)(l.A,{children:"regions"}),(0,a.jsx)(l.A,{children:"creatures + creature_stages"}),(0,a.jsx)(l.A,{children:"region_creatures spawn rates"}),(0,a.jsx)(l.A,{children:"story_missions unlocks"}),(0,a.jsx)(l.A,{children:"achievements"})]}),(0,a.jsx)("div",{className:"du-divider"}),(0,a.jsx)(n.z,{disabled:!c,children:"Open admin glass modal"}),"loading"===r?(0,a.jsx)("div",{className:"du-meta",children:"Checking session…"}):null]}),(0,a.jsxs)(s.Z,{title:"Regiones",badge:(0,a.jsx)(l.A,{children:p.regions.length}),children:[(0,a.jsx)("div",{className:"du-meta",children:"Selecciona una regi\xf3n y define su pol\xedgono GeoJSON para que se vea dividida en el mapa del jugador."}),(0,a.jsx)("div",{className:"du-divider"}),(0,a.jsx)("div",{className:"du-chip-row",style:{flexWrap:"wrap"},children:p.regions.map(e=>(0,a.jsx)("button",{className:"du-map-pill".concat(g===e.id?" active":""),onClick:()=>_(e.id),disabled:!m,title:m?"Editar regi\xf3n":"Requiere admin",children:e.name},e.id))}),m?null:(0,a.jsx)("div",{className:"du-meta",style:{marginTop:10},children:"Requiere `profiles.role = admin` o `profiles.is_admin = true`."})]}),m?(0,a.jsx)(f,{regions:p.regions,activeRegionId:g}):null]})}function y(){var e,t;let r=(0,d.G)(),i=(null===(e=r.profile)||void 0===e?void 0:e.role)==="admin"||(null===(t=r.profile)||void 0===t?void 0:t.is_admin);return(0,a.jsxs)("div",{className:"du-stack",children:[(0,a.jsx)(s.Z,{title:"Admin",badge:(0,a.jsx)(l.A,{children:i?"Authorized":"Sign in as admin"}),children:(0,a.jsx)("p",{className:"du-meta",children:"Manage regions, creatures, stages, assignments, missions, achievements. Only visible if your profile is admin."})}),(0,a.jsx)(_,{})]})}},495:function(e,t,r){"use strict";r.d(t,{z:function(){return s}});var a=r(7437),i=r(2265);let n=e=>"ghost"===e?"du-button ghost":"quick"===e?"du-button du-quick":"du-button",s=(0,i.forwardRef)((e,t)=>{let{variant:r="solid",full:i,className:s,...l}=e;return(0,a.jsx)("button",{ref:t,className:"".concat(n(r)).concat(i?" du-btn-full":""," ").concat(null!=s?s:""),...l})});s.displayName="Button"},6013:function(e,t,r){"use strict";r.d(t,{Z:function(){return i}});var a=r(7437);function i(e){let{children:t,title:r,badge:i,footer:n,className:s}=e;return(0,a.jsxs)("div",{className:["du-card",s].filter(Boolean).join(" "),children:[(r||i)&&(0,a.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[r?(0,a.jsx)("h3",{style:{margin:0},children:r}):(0,a.jsx)("span",{}),i]}),t,n?(0,a.jsx)("div",{style:{marginTop:10},children:n}):null]})}},9135:function(e,t,r){"use strict";r.d(t,{A:function(){return i}});var a=r(7437);function i(e){let{children:t,className:r,style:i,variant:n}=e;return(0,a.jsx)("span",{className:["du-tag","ghost"===n?"du-tag--ghost":null,r].filter(Boolean).join(" "),style:i,children:t})}},857:function(e,t,r){"use strict";r.d(t,{H:function(){return l},a:function(){return o}});var a=r(7437),i=r(2265),n=r(1180);let s=(0,i.createContext)({userId:null,status:"loading",signOut:async()=>{}});function l(e){let{children:t}=e,r=(0,n.O)(),[l,o]=(0,i.useState)(null),[d,u]=(0,i.useState)(r?"loading":"signed_out"),[c,p]=(0,i.useState)(void 0);(0,i.useEffect)(()=>{if(!r){u("signed_out");return}let e=!1;(async()=>{var t;let{data:a,error:i}=await r.auth.getSession();if(!e){if(i){try{await r.auth.signOut()}catch(e){}u("signed_out"),p(i.message),o(null)}else(null===(t=a.session)||void 0===t?void 0:t.user)?(o(a.session.user.id),u("ready")):u("signed_out")}})();let{data:t}=r.auth.onAuthStateChange((e,t)=>{(null==t?void 0:t.user)?(o(t.user.id),u("ready")):(o(null),u("signed_out"))});return()=>{e=!0,null==t||t.subscription.unsubscribe()}},[r]);let m=async()=>{r&&(await r.auth.signOut(),o(null),u("signed_out"))};return(0,a.jsx)(s.Provider,{value:{userId:l,status:d,error:c,signOut:m},children:t})}function o(){return(0,i.useContext)(s)}},371:function(e,t,r){"use strict";r.d(t,{G:function(){return d},U:function(){return o}});var a=r(7437),i=r(2265),n=r(1180),s=r(857);let l=(0,i.createContext)({regions:[],creatures:[],creatureStages:[],playerCreatures:[],regionCreatures:[],cityCreatures:[],missions:[],missionProgress:[],achievements:[],userAchievements:[],bonds:[],battles:[],profile:null,trainerStats:[],playerStats:[],xpThresholds:[],factions:[],cities:[],status:"idle",isLive:!1,reload:async()=>{}});function o(e){let{children:t}=e,r=(0,n.O)(),{userId:o,status:d}=(0,s.a)(),[u,c]=(0,i.useState)("idle"),[p,m]=(0,i.useState)(void 0),[g,f]=(0,i.useState)([]),[_,y]=(0,i.useState)([]),[h,v]=(0,i.useState)([]),[x,b]=(0,i.useState)([]),[j,S]=(0,i.useState)([]),[w,N]=(0,i.useState)([]),[k,A]=(0,i.useState)([]),[C,q]=(0,i.useState)([]),[E,F]=(0,i.useState)([]),[O,L]=(0,i.useState)([]),[M,P]=(0,i.useState)([]),[R,z]=(0,i.useState)([]),[G,T]=(0,i.useState)([]),[W,B]=(0,i.useState)(null),[D,Z]=(0,i.useState)(!1),[I,J]=(0,i.useState)([]),[U,H]=(0,i.useState)([]),[X,K]=(0,i.useState)([]),[Q,V]=(0,i.useState)([]),Y=async()=>{if(!r||!o){c("idle"),Z(!1);return}c("loading"),m(void 0);let e=[],[t,a,i,n,s,l,d,u,p,g,_,h,x,j,w,k,C,E]=await Promise.all([r.from("profiles").select("*").eq("id",o).maybeSingle(),r.from("creatures").select("id, name, name_locales, base_type, region, image_url, is_starter, rarity, sexes"),r.from("creature_stages").select("id, creature_id, stage_name, stage_order, stage_stats, image_url, variant_type, xp_required"),r.from("player_creatures").select("user_id, creature_id, current_stage_id, nickname, variant_type, date_caught, custom_stats, current_xp, level, in_party, party_slot, is_domesticated, stats, sex").eq("user_id",o),r.from("regions").select("id, name, color, island, municipalities, map_polygon"),r.from("region_creatures").select("region_id, creature_id, spawn_rate"),r.from("cities").select("id, name, region_id"),r.from("city_creatures").select("city_id, creature_id, spawn_rate"),r.from("story_missions").select("id, title, description, region_id, order_in_story, unlock_requirements, reward_cc, reward_item, mission_difficulty, is_battle, trainer_id"),r.from("player_mission_progress").select("user_id, mission_id, is_completed, completed_at, completion_date, rewards").eq("user_id",o),r.from("achievements").select("id, name, description, icon_url, criteria_json, reward_cc, reward_item"),r.from("user_achievements").select("id, user_id, achievement_id, achievement_name, description, date_earned, unlocked_at, notified_followers, track_id").eq("user_id",o),r.from("player_faction_bonds").select("user_id, faction, bond_amount").eq("user_id",o),r.from("battles").select("player1_id, player2_id, winner_id, battle_log, started_at, ended_at").or("player1_id.eq.".concat(o,",player2_id.eq.").concat(o)),r.from("player_trainer_stats").select("user_id, trainer_id, wins, losses, familiarity, last_battle_at").eq("user_id",o),r.from("player_stats").select("user_id, stat_key, stat_value").eq("user_id",o),r.from("creature_stage_xp_thresholds").select("id, creature_id, stage_id, xp_required, created_at, updated_at"),r.from("factions").select("id, name, description, color_hex, icon_url, slug, motto, alignment, lore_json")]),O=(t,r)=>{if(!r)return;let a="string"==typeof(null==r?void 0:r.message)?r.message:String(r);e.push("".concat(t,": ").concat(a))};O("profiles",t.error),O("creatures",a.error),O("creature_stages",i.error),O("player_creatures",n.error),O("regions",s.error),O("region_creatures",l.error),O("cities",d.error),O("city_creatures",u.error),O("story_missions",p.error),O("player_mission_progress",g.error),O("achievements",_.error),O("user_achievements",h.error),O("player_faction_bonds",x.error),O("battles",j.error),O("player_trainer_stats",w.error),O("player_stats",k.error),O("creature_stage_xp_thresholds",C.error),O("factions",E.error),t.data&&B(t.data),a.data&&v(a.data),i.data&&b(i.data.map(e=>{var t;return{...e,stage_stats:"string"==typeof e.stage_stats?JSON.parse(e.stage_stats):null!==(t=e.stage_stats)&&void 0!==t?t:{hp:0,atk:0,def:0,speed:0,faith:0}}})),n.data&&S(n.data),s.data&&f(s.data),l.data&&N(l.data),d.data&&y(d.data),u.data&&A(u.data),p.data&&q(p.data),g.data&&F(g.data),_.data&&L(_.data),h.data&&P(h.data),x.data&&z(x.data),j.data&&T(j.data),w.data&&J(w.data),k.data&&H(k.data),C.data&&K(C.data),E.data&&V(E.data),Z(!0),e.length?(c("error"),m(e.join(" | "))):c("ready")};(0,i.useEffect)(()=>{"ready"===d&&Y()},[d,o]);let $=(0,i.useMemo)(()=>({regions:g,creatures:h,creatureStages:x,playerCreatures:j,regionCreatures:w,cityCreatures:k,missions:C,missionProgress:E,achievements:O,userAchievements:M,bonds:R,battles:G,profile:W,trainerStats:I,playerStats:U,xpThresholds:X,factions:Q,cities:_,status:u,error:p,isLive:D,reload:Y}),[g,h,x,j,w,C,E,O,M,R,G,W,I,U,X,Q,u,p,D]);return(0,a.jsx)(l.Provider,{value:$,children:t})}function d(){return(0,i.useContext)(l)}},1180:function(e,t,r){"use strict";r.d(t,{O:function(){return n}});var a=r(3234);let i=null;function n(){if(i)return i;let e="https://npdklestjuejrotjtqwt.supabase.co",t="sb_publishable_9xEllkhUFl85xTTXtDDT5g_ei508t0r";return e&&t?i=(0,a.eI)(e,t,{auth:{persistSession:!0,autoRefreshToken:!0}}):null}}},function(e){e.O(0,[402,234,971,23,744],function(){return e(e.s=290)}),_N_E=e.O()}]);