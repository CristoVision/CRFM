(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[857],{8678:function(e,a,t){Promise.resolve().then(t.bind(t,6337))},6337:function(e,a,t){"use strict";t.r(a),t.d(a,{default:function(){return R}});var n=t(7437),r=t(2265),l=t(495),i=t(6013),s=t(9135),d=t(931),o=t(371);function c(e){let{logs:a}=e;return(0,n.jsx)(i.Z,{title:"Recent battles",children:(0,n.jsxs)("div",{className:"du-list",children:[a.map((e,a)=>(0,n.jsxs)("div",{className:"du-card",style:{padding:10},children:[(0,n.jsxs)("div",{className:"du-chip-row",children:[(0,n.jsxs)(s.A,{children:["player1_id: ",e.player1_id]}),(0,n.jsxs)(s.A,{children:["player2_id: ",e.player2_id]})]}),(0,n.jsxs)("div",{className:"du-chip-row",children:[(0,n.jsxs)(s.A,{children:["Winner: ",e.winner_id]}),e.started_at?(0,n.jsxs)(s.A,{children:["Start: ",e.started_at]}):null,e.ended_at?(0,n.jsxs)(s.A,{children:["End: ",e.ended_at]}):null]}),(0,n.jsx)("div",{className:"du-meta",children:"string"==typeof e.battle_log?e.battle_log:JSON.stringify(e.battle_log)})]},a)),0===a.length&&(0,n.jsx)("p",{className:"du-meta",children:"No battles yet."})]})})}var u=t(1180);let h={fuego:{strong:["planta","hielo"],weak:["agua","tierra"]},agua:{strong:["fuego","tierra"],weak:["planta","electrico"]},planta:{strong:["agua","tierra"],weak:["fuego","hielo"]},electrico:{strong:["agua","aire"],weak:["tierra"]},tierra:{strong:["electrico","fuego"],weak:["agua","planta"]},aire:{strong:["planta"],weak:["electrico","hielo"]},hielo:{strong:["planta","aire"],weak:["fuego"]},luz:{strong:["sombra"],weak:["sombra"]},sombra:{strong:["luz"],weak:["luz"]}},m=[{id:"quick",label:"Corte Veloz",kind:"attack",power:8,accuracy:98,priority:1,description:"Golpe rapido que asegura la iniciativa."},{id:"heavy",label:"Golpe Titan",kind:"attack",power:12,accuracy:88,priority:0,description:"Ataque fuerte con alto impacto."},{id:"guard",label:"Guardia Santa",kind:"guard",power:0,accuracy:100,priority:0,description:"Reduce el siguiente dano y recupera HP."},{id:"focus",label:"Focus de Fe",kind:"focus",power:0,accuracy:100,priority:0,description:"Carga Bond y aumenta precision."},{id:"bond",label:"Ruptura de Bond",kind:"attack",power:14,accuracy:92,bondCost:40,priority:0,description:"Descarga Bond para un golpe devastador."}],p=(e,a,t)=>Math.max(1,Math.round(e*t/10-.28*a)),v=e=>(e||"").normalize("NFD").replace(/[^\w\s-]/g,"").toLowerCase().trim(),g=(e,a)=>{let t=v(e),n=v(a);if(!t||!n)return 1;let r=h[t];return r?r.strong.includes(n)?1.2:r.weak.includes(n)?.85:1:1},x=e=>!!e&&(e.startsWith("http")||e.startsWith("data:")),f=e=>(e||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9]+/g," ").trim(),j=["CotorraChick.png","CoquiTad.png","JibaroPup.png","JibaroPupS.png"],b=e=>"male"===e?"♂":"female"===e?"♀":"";function C(e,a,t,n,r){let l=e?n.creatures.find(a=>a.id===e):void 0,i=a?n.creatureStages.find(e=>e.id===a):n.creatureStages.find(a=>a.creature_id===e),s=[],d=e=>{e&&(x(e)?s.push(e):r&&s.push("".concat(r,"/storage/v1/object/public/").concat(e.replace(/^\//,""))))};if("male"===t&&d((null==i?void 0:i.image_url_male)||void 0),"female"===t&&d((null==i?void 0:i.image_url_female)||void 0),d(null==i?void 0:i.image_url),d(null==l?void 0:l.image_url),r&&(null==l?void 0:l.name)){let e=f(l.name),a=e.replace(/ /g,""),t=e.toLowerCase().replace(/ /g,"-");j.forEach(e=>d("creatures/".concat(e))),["creatures/".concat(a,".png"),"creatures/".concat(t,".png"),"creatures/".concat(a,".jpg"),"creatures/".concat(t,".jpg"),"creatures/".concat(a,".webp"),"creatures/".concat(t,".webp"),"creatures/".concat(a,"S.png"),"creatures/".concat(a,"S.jpg"),"creatures/".concat(a,"S.webp")].forEach(d)}return s}function _(e,a,t){var n,r,l,i,s,d,o,c,u,h,m,p,v,g,x,f,j,b,C,_;if(!e)return{name:t.name,hp:null!==(n=t.hp)&&void 0!==n?n:20,atk:null!==(r=t.atk)&&void 0!==r?r:6,def:null!==(l=t.def)&&void 0!==l?l:3,spd:null!==(i=t.spd)&&void 0!==i?i:5,bond:null!==(s=t.bond)&&void 0!==s?s:0,baseType:t.baseType};let N=a.playerCreatures.find(a=>a.creature_id===e),w=a.creatures.find(a=>a.id===e),y=N&&N.current_stage_id?a.creatureStages.find(e=>e.id===N.current_stage_id):a.creatureStages.filter(a=>a.creature_id===e).sort((e,a)=>{var t,n;return(null!==(t=e.stage_order)&&void 0!==t?t:0)-(null!==(n=a.stage_order)&&void 0!==n?n:0)})[0],k=(null==y?void 0:y.stage_stats)||(null==N?void 0:N.stats)||{};return{id:e,stageId:null==y?void 0:y.id,name:(null==N?void 0:N.nickname)||(null==w?void 0:w.name)||t.name,hp:null!==(c=null!==(o=null!==(d=k.hp)&&void 0!==d?d:k.health)&&void 0!==o?o:t.hp)&&void 0!==c?c:20,atk:null!==(m=null!==(h=null!==(u=k.atk)&&void 0!==u?u:k.attack)&&void 0!==h?h:t.atk)&&void 0!==m?m:6,def:null!==(g=null!==(v=null!==(p=k.def)&&void 0!==p?p:k.defense)&&void 0!==v?v:t.def)&&void 0!==g?g:3,spd:null!==(j=null!==(f=null!==(x=k.speed)&&void 0!==x?x:k.spd)&&void 0!==f?f:t.spd)&&void 0!==j?j:5,bond:null!==(b=k.faith)&&void 0!==b?b:0,baseType:null==w?void 0:w.base_type,sex:null!==(_=null!==(C=null==N?void 0:N.sex)&&void 0!==C?C:t.sex)&&void 0!==_?_:null}}let N=(e,a)=>{var t,n;return{...e,maxHp:e.hp,hp:null!=a?a:e.hp,bondAffinity:null!==(t=e.bond)&&void 0!==t?t:0,bondCharge:Math.min(100,(null!==(n=e.bond)&&void 0!==n?n:0)*4),guardTurns:0,focusTurns:0}},w=e=>{if(e.hp<=.35*e.maxHp)return m.find(e=>"guard"===e.id);if(e.bondCharge>=40)return m.find(e=>"bond"===e.id);let a=Math.random();return a<.45?m.find(e=>"quick"===e.id):a<.75?m.find(e=>"heavy"===e.id):m.find(e=>"focus"===e.id)},y=function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:100;return Math.max(a,Math.min(t,e))};function k(){var e,a,t,h,v,x,f,j,k,S;let{battle:T,startBattle:E,reset:M,addLog:D,awardStageAndXp:A,recordBattle:P}=(0,d.A)(),z=(0,o.G)(),R=(0,u.O)(),{profile:B,bonds:I,battles:H,trainerStats:q}=z,F=H[0],G="https://npdklestjuejrotjtqwt.supabase.co",Z=G?"".concat(G,"/storage/v1/object/public/creatures/UnknownCreature.png"):void 0,[O,L]=(0,r.useState)(null===(e=z.regions[0])||void 0===e?void 0:e.id),[U,V]=(0,r.useState)("trainer"),[W,X]=(0,r.useState)("idle"),[J,K]=(0,r.useState)(""),[Q,$]=(0,r.useState)(1),[Y,ee]=(0,r.useState)(0),[ea,et]=(0,r.useState)({}),[en,er]=(0,r.useState)(null),[el,ei]=(0,r.useState)(null),[es,ed]=(0,r.useState)(void 0),[eo,ec]=(0,r.useState)(null),[eu,eh]=(0,r.useState)("idle"),[em,ep]=(0,r.useState)(!1),[ev,eg]=(0,r.useState)(!1),ex=(0,r.useRef)(null),ef=(0,r.useRef)(null),ej=z.playerCreatures.slice(0,6),eb=null===(a=ej[Y])||void 0===a?void 0:a.creature_id,eC=(0,r.useMemo)(()=>{var e,a;let t=null!=O?O:null===(e=z.regions[0])||void 0===e?void 0:e.id;if(!t)return;let n=(z.regionCreatures||[]).filter(e=>e.region_id===t);if(!n.length)return;let r=n.reduce((e,a)=>{var t;return e+(null!==(t=a.spawn_rate)&&void 0!==t?t:1)},0);if(r<=0)return n[0].creature_id;let l=Math.random()*r;for(let e of n)if((l-=null!==(a=e.spawn_rate)&&void 0!==a?a:1)<=0)return e.creature_id;return n[n.length-1].creature_id},[O,z.regionCreatures,z.regions]),e_=C(eb,null==en?void 0:en.stageId,null==en?void 0:en.sex,z,G),eN=C(es,null==el?void 0:el.stageId,null!==(t=null==el?void 0:el.sex)&&void 0!==t?t:eo,z,G),ew=()=>_(eb,z,{name:"Sin criatura",hp:22,atk:6,def:3,spd:5,bond:0}),ey=(e,a,t)=>_(e,z,{name:"wild"===a?"Criatura salvaje":"Entrenador NPC",hp:20,atk:6,def:3,spd:4,bond:0,sex:null!=t?t:null,baseType:"wild"===a?"Salvaje":"Trainer"});(0,r.useEffect)(()=>{"idle"===T.mode&&(X("idle"),eh("idle"),K(""),er(null),ei(null),et({}),ed(void 0),ec(null))},[T.mode]),(0,r.useEffect)(()=>{en&&(null!==ex.current&&en.hp<ex.current&&(ep(!0),window.setTimeout(()=>ep(!1),280)),ex.current=en.hp)},[null==en?void 0:en.hp]),(0,r.useEffect)(()=>{el&&(null!==ef.current&&el.hp<ef.current&&(eg(!0),window.setTimeout(()=>eg(!1),280)),ef.current=el.hp)},[null==el?void 0:el.hp]);let ek=e=>{var a,t;let n=null!=e?e:U;if(V(n),!ej.length)return;let r="wild"===n?eC:null===(a=z.creatures.find(e=>e.id!==eb))||void 0===a?void 0:a.id;ed(r);let l=z.creatures.find(e=>e.id===r),i=(null==l?void 0:l.sexes)&&l.sexes.length?l.sexes:["male","female"],s=i[Math.floor(Math.random()*i.length)];ec(s);let d=ew(),o=ey(r,n,s),c={};ej.forEach(e=>{c[e.creature_id]=_(e.creature_id,z,{name:""}).hp}),et(c),er(N(d,null!==(t=c[null!=eb?eb:""])&&void 0!==t?t:d.hp)),ei(N(o)),X("action"),eh("idle"),$(1),K("wild"===n?"\xa1Aparece ".concat(o.name,"!"):"Desafio contra ".concat(o.name)),E(n)},eS=e=>{D(e)},eT=(e,a,t)=>{var n,r;let l=[];if("guard"===t.kind){e.guardTurns=1;let a=Math.min(e.maxHp-e.hp,4);return e.hp+=a,e.bondCharge=y(e.bondCharge+10),l.push("".concat(e.name," se protege y recupera ").concat(a," HP.")),l}if("focus"===t.kind)return e.focusTurns=2,e.bondCharge=y(e.bondCharge+22),l.push("".concat(e.name," concentra su fe. Bond +22.")),l;if(t.bondCost&&e.bondCharge<t.bondCost)return l.push("".concat(e.name," intento ").concat(t.label," pero no tiene Bond.")),l;if(100*Math.random()>(null!==(n=t.accuracy)&&void 0!==n?n:100)+(e.focusTurns>0?6:0))return l.push("".concat(e.name," fallo ").concat(t.label,".")),l;let i=p(e.atk,a.def,null!==(r=t.power)&&void 0!==r?r:10),s=g(e.baseType,a.baseType),d=Math.max(1,Math.round((i+("bond"===t.id?Math.round(.6*e.bondAffinity):0))*(.9+.2*Math.random())*s));return a.guardTurns>0&&(d=Math.max(1,Math.round(.6*d)),a.guardTurns=0,l.push("".concat(a.name," bloqueo parte del impacto."))),a.hp=Math.max(0,a.hp-d),e.bondCharge=y(e.bondCharge+12),t.bondCost&&(e.bondCharge=y(e.bondCharge-t.bondCost)),l.push("".concat(e.name," uso ").concat(t.label," (").concat(d," dmg). ").concat(s>1.05?"\xa1Super eficaz!":s<.95?"No muy eficaz.":"").trim()),l},eE=(e,a)=>{e.focusTurns>0&&(e.focusTurns-=1),a.focusTurns>0&&(a.focusTurns-=1)},eM=e=>{if(!en||!el)return;let a={...en},t={...el},n=w(t),r=[{who:"player",move:e,actor:a,target:t},{who:"enemy",move:n,actor:t,target:a}].sort((e,a)=>{var t,n;let r=null!==(t=e.move.priority)&&void 0!==t?t:0,l=null!==(n=a.move.priority)&&void 0!==n?n:0;return r!==l?l-r:e.actor.spd!==a.actor.spd?a.actor.spd-e.actor.spd:"player"===e.who?-1:1}),l=[];for(let e of r){if(a.hp<=0||t.hp<=0)break;l.push(...eT(e.actor,e.target,e.move))}if(eE(a,t),l.forEach(eS),er(a),ei(t),eb&&et(e=>({...e,[eb]:a.hp})),t.hp<=0){var i;eS("Victoria: enemigo derrotado."),eh("victory"),X("outcome"),K("\xa1Victoria!"),eb&&A({creatureId:eb,xpGain:12}),P({winner_id:null!==(i=null==B?void 0:B.id)&&void 0!==i?i:"npc",battle_log:T.log.join(" | ")});return}if(a.hp<=0){eS("Derrota: tu criatura cayo."),eh("defeat"),X("outcome"),K("Derrota."),P({winner_id:"npc",battle_log:T.log.join(" | ")});return}let s=Q+1;$(s),X("action"),K("Turno ".concat(s,": \xbfque hara ").concat(a.name,"?"))},eD=e=>{var a,t;if(e===Y||!en||!el)return;let n=null===(a=ej[e])||void 0===a?void 0:a.creature_id;if(!n)return;let r=null!==(t=ea[n])&&void 0!==t?t:_(n,z,{name:""}).hp;if(r<=0)return;let l=N(_(n,z,{name:""}),r);ee(e),er(l);let i={...el},s=w(i);eT(i,l,s).forEach(eS),er(l),ei(i),et(e=>({...e,[n]:l.hp})),l.hp<=0?(eh("defeat"),X("outcome"),K("Derrota.")):(X("action"),K("Cambio listo. \xbfQue hara ".concat(l.name,"?")))},eA=async()=>{var e,a,t,n;if("wild"!==U||!R||!(null==B?void 0:B.id)||!(null==el?void 0:el.id)||!el)return;let r=el.hp,l=el.maxHp,i=z.regionCreatures.find(e=>{var a;return e.creature_id===el.id&&e.region_id===(null!=O?O:null===(a=z.regions[0])||void 0===a?void 0:a.id)}),s=25+50*Math.max(0,(l-r)/l)+Math.min(20,2*(null!==(e=null==i?void 0:i.spawn_rate)&&void 0!==e?e:1));if(s>90&&(s=90),!(100*Math.random()<=s)){eS("Domesticar fallo (".concat(Math.round(s),"% chance).")),K("El enemigo se resiste."),eM(m.find(e=>"guard"===e.id));return}let d=z.creatureStages.filter(e=>e.creature_id===el.id).sort((e,a)=>{var t,n;return(null!==(t=e.stage_order)&&void 0!==t?t:0)-(null!==(n=a.stage_order)&&void 0!==n?n:0)})[0];await R.from("player_creatures").insert({user_id:B.id,creature_id:el.id,current_stage_id:null!==(a=null==d?void 0:d.id)&&void 0!==a?a:null,current_xp:0,nickname:el.name,is_domesticated:!0,domesticated_at:new Date().toISOString(),level:null!==(t=null==d?void 0:d.stage_order)&&void 0!==t?t:1,sex:null!==(n=el.sex)&&void 0!==n?n:null}),eS("Domesticaste a ".concat(el.name,".")),eh("capture"),X("outcome"),K("Domesticar exitoso."),P({winner_id:B.id,battle_log:[...T.log,"Domesticar ".concat(el.name)].join(" | ")}),z.reload()},eP=m.filter(e=>"attack"===e.kind||"guard"===e.id),ez="action"===W||"move"===W||"switch"===W,eR="idle"===W?"Preparando combate":"action"===W?"Turno ".concat(Q,": tu decides"):"move"===W?"Elige tu movimiento":"switch"===W?"Cambia de criatura":"Resultado";return(0,n.jsxs)("div",{className:"du-grid two",children:[(0,n.jsx)(i.Z,{title:"Arena",badge:(0,n.jsx)(s.A,{children:"idle"===T.mode?"Idle":"Modo: ".concat(T.mode)}),children:(0,n.jsxs)("div",{className:"du-arena-shell",children:[(0,n.jsxs)("div",{className:"du-mode-tabs",children:[(0,n.jsx)("button",{className:"du-mode-chip".concat("wild"===U?" active":""),onClick:()=>{ek("wild")},children:"Encuentro"}),(0,n.jsx)("button",{className:"du-mode-chip".concat("trainer"===U?" active":""),onClick:()=>{ek("trainer")},children:"Entrenador"}),(0,n.jsx)("button",{className:"du-mode-chip".concat("pvp"===U?" active":""),onClick:()=>{ek("pvp")},children:"PvP"}),"wild"===U&&(0,n.jsx)("select",{className:"du-select",value:null!=O?O:"",onChange:e=>L(e.target.value),children:z.regions.map(e=>(0,n.jsx)("option",{value:e.id,children:e.name},e.id))})]}),ej.length?null:(0,n.jsx)("div",{className:"du-callout",children:"Necesitas domesticar al menos una criatura para iniciar combates."}),"idle"===W?(0,n.jsx)("div",{className:"du-callout",children:"Selecciona un modo para iniciar la batalla."}):null,en&&el?(0,n.jsxs)("div",{className:"du-battle-stage",children:[(0,n.jsxs)("div",{className:"du-battle-topbar",children:[(0,n.jsx)("div",{className:"du-turn-indicator",children:eR}),(0,n.jsxs)("div",{className:"du-chip-row",children:[(0,n.jsxs)(s.A,{children:["Turno ",Q]}),(0,n.jsx)(s.A,{children:T.mode})]})]}),(0,n.jsxs)("div",{className:"du-battle-hud enemy".concat("idle"===W||"outcome"===W||ez?"":" active").concat(ev?" hit":""),children:[(0,n.jsxs)("div",{className:"du-battle-name",children:[el.name,b(null!==(h=el.sex)&&void 0!==h?h:eo)?(0,n.jsx)("span",{className:"du-sex-chip",children:b(null!==(v=el.sex)&&void 0!==v?v:eo)}):null]}),(0,n.jsx)("div",{className:"du-battle-type",children:null!==(x=el.baseType)&&void 0!==x?x:"Tipo"}),(0,n.jsx)("div",{className:"du-hp-bar",children:(0,n.jsx)("span",{style:{width:"".concat(el.hp/el.maxHp*100,"%")}})}),(0,n.jsxs)("div",{className:"du-hp-meta",children:["HP ",el.hp,"/",el.maxHp]}),(0,n.jsxs)("div",{className:"du-battle-stats-row",children:[(0,n.jsxs)("span",{children:["ATK ",el.atk]}),(0,n.jsxs)("span",{children:["DEF ",el.def]}),(0,n.jsxs)("span",{children:["SPD ",el.spd]})]}),(0,n.jsx)("div",{className:"du-battle-portrait",children:(0,n.jsx)("img",{src:null!==(f=eN[0])&&void 0!==f?f:Z,alt:el.name,className:"du-card-img",onError:e=>{let a=e.currentTarget;a.src!==Z&&Z&&(a.src=Z)}})})]}),(0,n.jsxs)("div",{className:"du-battle-hud player".concat(ez?" active":"").concat(em?" hit":""),children:[(0,n.jsxs)("div",{className:"du-battle-name",children:[en.name,b(en.sex)?(0,n.jsx)("span",{className:"du-sex-chip",children:b(en.sex)}):null]}),(0,n.jsx)("div",{className:"du-battle-type",children:null!==(j=en.baseType)&&void 0!==j?j:"Tipo"}),(0,n.jsx)("div",{className:"du-hp-bar",children:(0,n.jsx)("span",{style:{width:"".concat(en.hp/en.maxHp*100,"%")}})}),(0,n.jsxs)("div",{className:"du-hp-meta",children:["HP ",en.hp,"/",en.maxHp]}),(0,n.jsxs)("div",{className:"du-battle-stats-row",children:[(0,n.jsxs)("span",{children:["ATK ",en.atk]}),(0,n.jsxs)("span",{children:["DEF ",en.def]}),(0,n.jsxs)("span",{children:["SPD ",en.spd]})]}),(0,n.jsxs)("div",{className:"du-bond-row",children:[(0,n.jsx)("span",{children:"Bond"}),(0,n.jsx)("div",{className:"du-bond-bar",children:(0,n.jsx)("span",{style:{width:"".concat(en.bondCharge,"%")}})}),(0,n.jsx)("span",{children:en.bondCharge})]}),(0,n.jsx)("div",{className:"du-battle-portrait",children:(0,n.jsx)("img",{src:null!==(k=e_[0])&&void 0!==k?k:Z,alt:en.name,className:"du-card-img",onError:e=>{let a=e.currentTarget;a.src!==Z&&Z&&(a.src=Z)}})})]})]}):null,(0,n.jsx)("div",{className:"du-battle-textbox",children:(0,n.jsx)("div",{className:"du-meta",children:J||"Preparando combate..."})}),"action"===W&&en&&el?(0,n.jsxs)("div",{className:"du-battle-menu du-action-grid",children:[(0,n.jsx)(l.z,{onClick:()=>X("move"),className:"du-action-btn primary",children:"⚔️ Atacar"}),(0,n.jsx)(l.z,{variant:"ghost",onClick:()=>X("switch"),className:"du-action-btn",children:"\uD83D\uDD01 Cambiar"}),(0,n.jsx)(l.z,{variant:"ghost",onClick:()=>eM(m.find(e=>"focus"===e.id)),className:"du-action-btn",children:"✨ Bond"}),"wild"===U?(0,n.jsx)(l.z,{variant:"ghost",onClick:()=>{if("wild"===U&&en&&el){if(100*Math.random()<=y(40+(en.spd-el.spd)*5,10,80)){eS("Escapaste del combate."),eh("run"),X("outcome"),K("Escapaste sin perder honor.");return}eS("No pudiste escapar."),eM(m.find(e=>"guard"===e.id))}},className:"du-action-btn",children:"\uD83C\uDFC3 Escapar"}):(0,n.jsx)(l.z,{variant:"ghost",onClick:()=>eM(m.find(e=>"guard"===e.id)),className:"du-action-btn",children:"\uD83D\uDEE1️ Defender"})]}):null,"move"===W&&en?(0,n.jsxs)("div",{className:"du-battle-menu du-move-menu",children:[eP.map(e=>(0,n.jsxs)("button",{className:"du-move-btn".concat(e.bondCost&&en.bondCharge<e.bondCost?" disabled":""),onClick:()=>{e.bondCost&&en.bondCharge<e.bondCost||eM(e)},children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("strong",{children:e.label}),(0,n.jsx)("span",{className:"du-meta",children:e.description})]}),e.bondCost?(0,n.jsxs)("span",{className:"du-move-cost",children:["Bond ",e.bondCost]}):null]},e.id)),"wild"===U?(0,n.jsx)("button",{className:"du-move-btn",onClick:eA,children:(0,n.jsxs)("div",{children:[(0,n.jsx)("strong",{children:"Domesticar"}),(0,n.jsx)("span",{className:"du-meta",children:"Intenta capturar si esta debilitado."})]})}):null,(0,n.jsx)(l.z,{variant:"ghost",onClick:()=>X("action"),className:"du-action-btn",children:"Regresar"})]}):null,"switch"===W&&ej.length>1?(0,n.jsxs)("div",{className:"du-battle-menu du-switch-menu",children:[ej.map((e,a)=>{var t;let r=null!==(t=ea[e.creature_id])&&void 0!==t?t:_(e.creature_id,z,{name:""}).hp;return(0,n.jsx)("button",{className:"du-move-btn".concat(a===Y?" active":"").concat(r<=0?" disabled":""),onClick:()=>eD(a),children:(0,n.jsxs)("div",{children:[(0,n.jsx)("strong",{children:e.nickname||e.creature_id.slice(0,6)}),(0,n.jsxs)("span",{className:"du-meta",children:["HP ",r]})]})},e.creature_id)}),(0,n.jsx)(l.z,{variant:"ghost",onClick:()=>X("action"),className:"du-action-btn",children:"Regresar"})]}):null,"outcome"===W?(0,n.jsxs)("div",{className:"du-callout",children:["victory"===eu&&"Victoria: ganas XP y reputacion.","defeat"===eu&&"Derrota: reagrupa tu equipo.","run"===eu&&"Escapaste del combate.","capture"===eu&&"Criatura domestica a\xf1adida.",(0,n.jsxs)("div",{className:"du-chip-row",style:{marginTop:10},children:[(0,n.jsx)(l.z,{onClick:()=>{M(),ek()},variant:"ghost",children:"Nueva batalla"}),(0,n.jsx)(l.z,{onClick:()=>window.location.assign("/map"),variant:"ghost",children:"Ir al mapa"})]})]}):null]})}),(0,n.jsxs)(i.Z,{title:"Rewards",badge:(0,n.jsxs)(s.A,{children:["Wallet: ",null!==(S=null==B?void 0:B.wallet_balances)&&void 0!==S?S:0," CC"]}),children:[(0,n.jsx)("p",{children:"Cross Coins de profiles.wallet_balances \xb7 Bonds de player_faction_bonds."}),(0,n.jsx)("div",{className:"du-chip-row",children:I.map(e=>(0,n.jsxs)(s.A,{children:[e.faction,": ",e.bond_amount," Bonds"]},e.faction))}),(0,n.jsx)("div",{className:"du-divider"}),F?(0,n.jsxs)("div",{className:"du-meta",children:["Ultima batalla: ",F.winner_id," gano \xb7 ",F.battle_log]}):(0,n.jsx)("div",{className:"du-meta",children:"No battles yet"}),(0,n.jsx)("div",{className:"du-divider"}),(0,n.jsxs)("div",{className:"du-meta",children:["Trainer stats tracked: ",q.length]})]}),(0,n.jsx)(c,{logs:H.slice(0,5)})]})}var S=t(4660);let T=function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return[...e].sort(()=>.5-Math.random()).slice(0,a)},E=e=>{var a;let t=(null==e?void 0:null===(a=e.sexes)||void 0===a?void 0:a.length)?e.sexes:["male","female"];return t[Math.floor(Math.random()*t.length)]};function M(e,a,t){var n,r,l,i,s,d,o,c;let u=t.playerCreatures.find(a=>a.creature_id===e),h=t.creatures.find(a=>a.id===e),m=u?t.creatureStages.find(e=>e.id===u.current_stage_id):void 0,p=(null==m?void 0:m.stage_stats)||(null==u?void 0:u.stats)||{};return{name:(null==u?void 0:u.nickname)||(null==h?void 0:h.name)||a,hp:null!==(r=null!==(n=p.hp)&&void 0!==n?n:p.health)&&void 0!==r?r:24,atk:null!==(i=null!==(l=p.atk)&&void 0!==l?l:p.attack)&&void 0!==i?i:6,def:null!==(d=null!==(s=p.def)&&void 0!==s?s:p.defense)&&void 0!==d?d:3,spd:null!==(c=null!==(o=p.speed)&&void 0!==o?o:p.spd)&&void 0!==c?c:5}}function D(e,a){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=[],r=e.hp,l=a.hp,i=e.spd>=a.spd,s=(e,a)=>Math.max(1,Math.round(e-.4*a)),d=0;for(;r>0&&l>0&&d<14;){if(i){let t=s(e.atk,a.def);l-=t,n.push("".concat(e.name," ataca (").concat(t," dmg). Enemigo HP ").concat(Math.max(l,0),"/").concat(a.hp))}else{let l=s(a.atk+(t?2:0),e.def);r-=l,n.push("".concat(a.name," responde (").concat(l," dmg). Tu HP ").concat(Math.max(r,0),"/").concat(e.hp))}i=!i,d+=1}return{log:n,winner:r>0?"player":"enemy"}}function A(){var e,a,t,c,h;let m=(0,o.G)(),p=(0,u.O)(),{tutorial:v,updateTutorial:g,startTutorial:x,completeTutorial:f,skipTutorial:j,restartTutorial:b,addLog:C,battle:_,reset:N,awardStageAndXp:w,recordBattle:y}=(0,d.A)(),[k,A]=(0,r.useState)([]),[P,z]=(0,r.useState)("idle"),[R,B]=(0,r.useState)("idle"),I=(0,r.useMemo)(()=>m.creatures.filter(e=>e.is_starter),[m.creatures]),H=0===m.playerCreatures.length,q="completed"!==v.status,F=null!==(h=v.step)&&void 0!==h?h:0;(0,r.useEffect)(()=>{var e;"completed"===v.status||(null===(e=v.starterPool)||void 0===e?void 0:e.length)||!I.length||g({starterPool:T(I,3).map(e=>e.id)})},[v.starterPool,I,v.status,g]);let G=(0,r.useMemo)(()=>{var e;return(null===(e=v.starterPool)||void 0===e?void 0:e.length)?v.starterPool.map(e=>m.creatures.find(a=>a.id===e)).filter(Boolean):[]},[v.starterPool,m.creatures]),Z=(0,r.useMemo)(()=>{let e=new Set([v.starterChoice,v.captureChoice].filter(Boolean));return I.map(e=>e.id).filter(a=>!e.has(a))},[I,v.starterChoice,v.captureChoice]);(0,r.useEffect)(()=>{if("in_progress"===v.status&&!(F<3)&&!v.captureChoice&&Z.length){let e=T(Z,1)[0],a=m.creatures.find(a=>a.id===e);g({captureChoice:e,captureSex:a?E(a):void 0})}},[v.status,F,Z,v.captureChoice,m.creatures,g]),(0,r.useEffect)(()=>{if("in_progress"===v.status&&!(F<4)&&!v.npcChoice&&Z.length){let e=T(Z,1)[0],a=m.creatures.find(a=>a.id===e);g({npcChoice:e,npcSex:a?E(a):void 0})}},[v.status,F,Z,v.npcChoice,m.creatures,g]);let O=async(e,a,t)=>{var n,r,l;if(!p||!(null===(n=m.profile)||void 0===n?void 0:n.id)||!e||m.playerCreatures.find(a=>a.creature_id===e))return;let i=m.creatureStages.filter(a=>a.creature_id===e).sort((e,a)=>{var t,n;return(null!==(t=e.stage_order)&&void 0!==t?t:0)-(null!==(n=a.stage_order)&&void 0!==n?n:0)})[0],s=m.creatures.find(a=>a.id===e);await p.from("player_creatures").insert({user_id:m.profile.id,creature_id:e,current_stage_id:null!==(r=null==i?void 0:i.id)&&void 0!==r?r:null,nickname:(0,S.l)((null==s?void 0:s.name)||"Starter",null==s?void 0:s.name_locales),variant_type:"base",date_caught:new Date().toISOString(),current_xp:0,level:null!==(l=null==i?void 0:i.stage_order)&&void 0!==l?l:1,is_domesticated:!0,in_party:!0,party_slot:t,sex:null!=a?a:null}),await m.reload()},L=async e=>{let a=m.creatures.find(a=>a.id===e),t=a?E(a):void 0;g({starterChoice:e,starterSex:t,step:2}),x(),await O(e,t,1)},U=async()=>{var e,a,t;let n=v.starterChoice||(null===(e=m.playerCreatures[0])||void 0===e?void 0:e.creature_id);if(!n)return;let r=D(M(n,"Starter",m),{name:"Criatura salvaje",hp:18,atk:6,def:3,spd:4},!1);A(r.log),r.log.forEach(C),z("player"===r.winner?"player":"enemy"),"player"===r.winner&&(await w({creatureId:n,xpGain:12}),await y({winner_id:null!==(t=null===(a=m.profile)||void 0===a?void 0:a.id)&&void 0!==t?t:"npc",battle_log:r.log.join(" | ")})),g({step:3})},V=async()=>{if(!v.captureChoice)return;let e=m.playerCreatures.length+1;await O(v.captureChoice,v.captureSex,e),g({step:4})},W=async()=>{var e,a,t;let n=v.starterChoice||(null===(e=m.playerCreatures[0])||void 0===e?void 0:e.creature_id);if(!n||!v.npcChoice||!p)return;let r=M(n,"Starter",m),l=M(v.npcChoice,"Entrenador rival",m),i=D(r,{...l,hp:l.hp+6,atk:l.atk+2},!0);A(i.log),i.log.forEach(C),z("player"===i.winner?"player":"enemy"),"player"===i.winner&&(await w({creatureId:n,xpGain:12}),await y({winner_id:null!==(t=null===(a=m.profile)||void 0===a?void 0:a.id)&&void 0!==t?t:"npc",battle_log:i.log.join(" | ")}));let{data:s,error:d}=await p.rpc("complete_du_tutorial");d||(null==s?void 0:s.ok)===!1?B("error"):B("awarded"),f(),g({step:5,rewardClaimed:!0})},X=()=>{A([]),z("idle"),B("idle")};return q?(0,n.jsxs)(i.Z,{title:"Tutorial de batalla",badge:(0,n.jsx)(s.A,{children:"in_progress"===v.status?"En progreso":H?"Elige starter":"Recomendado"}),footer:(0,n.jsxs)("div",{className:"du-chip-row",children:[F>0&&(0,n.jsx)(l.z,{variant:"ghost",onClick:()=>g({step:Math.max(0,F-1)}),children:"Atras"}),"completed"!==v.status&&(0,n.jsx)(l.z,{variant:"ghost",onClick:()=>{j(),X()},children:"Omitir"}),"completed"!==v.status&&0===F?(0,n.jsx)(l.z,{onClick:()=>{x(),g({step:H?1:2})},children:"Continuar"}):null,"completed"!==v.status&&2===F?(0,n.jsx)(l.z,{onClick:U,children:"Iniciar encuentro"}):null,"completed"!==v.status&&3===F?(0,n.jsx)(l.z,{onClick:V,children:"Domesticar criatura"}):null,"completed"!==v.status&&4===F?(0,n.jsx)(l.z,{onClick:W,children:"Batalla final"}):null,(0,n.jsx)(l.z,{variant:"ghost",onClick:()=>{b(),X()},children:"Reiniciar tutorial"}),(0,n.jsx)(l.z,{variant:"ghost",onClick:N,children:"Reset batalla"})]}),children:[(0,n.jsxs)("div",{className:"du-chip-row",children:[(0,n.jsxs)(s.A,{children:["Paso ",Math.min(F+1,6)," de 6"]}),(0,n.jsx)(s.A,{children:"completed"===v.status?"Completado":"Activo"})]}),0===F?(0,n.jsxs)("div",{className:"du-list",children:[(0,n.jsx)("div",{className:"du-meta",children:"1) Elige un starter para comenzar tu viaje."}),(0,n.jsx)("div",{className:"du-meta",children:"2) Completa un encuentro para ganar XP inicial."}),(0,n.jsx)("div",{className:"du-meta",children:"3) Domestica una segunda criatura."}),(0,n.jsx)("div",{className:"du-meta",children:"4) Vence al entrenador rival."}),(0,n.jsx)("div",{className:"du-meta",children:"Recompensa: 10 CC + logro de bienvenida."})]}):null,1===F&&H?(0,n.jsx)("div",{className:"du-grid three",children:G.map(e=>(0,n.jsxs)(i.Z,{title:(0,S.l)(e.name,e.name_locales),badge:(0,n.jsx)(s.A,{children:e.base_type}),footer:(0,n.jsx)(l.z,{onClick:()=>L(e.id),className:"du-btn-full",children:"Elegir"}),children:[(0,n.jsx)("div",{className:"du-starter-preview",children:(0,n.jsx)("span",{children:"\uD83D\uDC3E"})}),(0,n.jsxs)("div",{className:"du-meta",children:["Region: ",e.region]})]},e.id))}):null,2===F?(0,n.jsxs)("div",{className:"du-list",children:[(0,n.jsx)("div",{className:"du-meta",children:"Encuentro tutorial contra una criatura salvaje."}),(0,n.jsx)("div",{className:"du-meta",children:"Gana XP y desbloquea la siguiente fase."})]}):null,3===F&&v.captureChoice?(0,n.jsxs)("div",{className:"du-list",children:[(0,n.jsx)("div",{className:"du-meta",children:"Encuentro de captura"}),(0,n.jsxs)("div",{className:"du-meta",children:[(0,S.l)((null===(e=m.creatures.find(e=>e.id===v.captureChoice))||void 0===e?void 0:e.name)||"Criatura",null===(a=m.creatures.find(e=>e.id===v.captureChoice))||void 0===a?void 0:a.name_locales),v.captureSex?" \xb7 ".concat(v.captureSex):null]}),(0,n.jsx)("div",{className:"du-meta",children:"Domestica esta criatura para ampliar tu equipo."})]}):null,4===F&&v.npcChoice?(0,n.jsxs)("div",{className:"du-list",children:[(0,n.jsx)("div",{className:"du-meta",children:"Combate contra entrenador rival (ventaja)."}),(0,n.jsxs)("div",{className:"du-meta",children:["Rival: ",(0,S.l)((null===(t=m.creatures.find(e=>e.id===v.npcChoice))||void 0===t?void 0:t.name)||"Entrenador",null===(c=m.creatures.find(e=>e.id===v.npcChoice))||void 0===c?void 0:c.name_locales),v.npcSex?" \xb7 ".concat(v.npcSex):null]})]}):null,"completed"===v.status?(0,n.jsxs)("div",{className:"du-list",children:[(0,n.jsx)("div",{className:"du-meta",children:"Tutorial completado. Bienvenido al mundo de DU TCG PR."}),(0,n.jsx)("div",{className:"du-meta",children:"Recompensa: 10 CC + logro desbloqueado."}),"awarded"===R&&(0,n.jsx)(s.A,{children:"Recompensa aplicada"}),"error"===R&&(0,n.jsx)(s.A,{children:"Recompensa pendiente"})]}):null,k.length>0&&(0,n.jsxs)("div",{className:"du-list",style:{marginTop:10},children:[k.map((e,a)=>(0,n.jsx)("div",{className:"du-meta",children:e},a)),"idle"!==P&&(0,n.jsx)(s.A,{children:"player"===P?"Victoria":"Derrota"})]}),_.log.length>0&&(0,n.jsxs)("div",{className:"du-list",style:{marginTop:10},children:[(0,n.jsx)("div",{className:"du-meta",children:"Log de batalla"}),_.log.map((e,a)=>(0,n.jsx)("div",{className:"du-meta",children:e},a))]})]}):null}var P=t(857),z=t(357);function R(){let e=(0,o.G)(),{status:a}=(0,P.a)(),t=z.env.NEXT_PUBLIC_CRFM_URL,r=t?t.replace(/\/$/,""):"";return(0,n.jsxs)("div",{className:"du-stack",children:[(0,n.jsx)(i.Z,{title:"Battle",badge:(0,n.jsx)(s.A,{children:"Turn-based"}),children:(0,n.jsx)("p",{className:"du-meta",children:"Use your domesticated creatures and stage stats for HP/ATK/DEF/speed/faith. Rewards: wallet_balances + faction bonds."})}),"ready"!==a?(0,n.jsxs)(i.Z,{title:"Sesion requerida",badge:(0,n.jsx)(s.A,{children:"CRFM"}),children:[(0,n.jsx)("p",{className:"du-meta",children:"Inicia sesion en CRFM para activar batallas y progreso."}),(0,n.jsx)("a",{className:"du-button",href:"".concat(r,"/?auth=login"),rel:"noreferrer",children:"Ir a CRFM"})]}):null,(0,n.jsx)(k,{}),(0,n.jsx)(i.Z,{title:"Battles count",badge:(0,n.jsx)(s.A,{children:e.battles.length}),children:(0,n.jsx)("p",{className:"du-meta",children:"Latest battles are listed in the log below."})}),(0,n.jsx)(A,{})]})}},6013:function(e,a,t){"use strict";t.d(a,{Z:function(){return r}});var n=t(7437);function r(e){let{children:a,title:t,badge:r,footer:l,className:i}=e;return(0,n.jsxs)("div",{className:["du-card",i].filter(Boolean).join(" "),children:[(t||r)&&(0,n.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[t?(0,n.jsx)("h3",{style:{margin:0},children:t}):(0,n.jsx)("span",{}),r]}),a,l?(0,n.jsx)("div",{style:{marginTop:10},children:l}):null]})}},4660:function(e,a,t){"use strict";t.d(a,{l:function(){return r}});let n=()=>{let e=window.localStorage.getItem("crfm_language");return"en"===e||"es"===e?e:(window.navigator.language||"").toLowerCase().startsWith("en")?"en":"es"},r=(e,a)=>a&&(a[n()]||a.es||a.en)||e}},function(e){e.O(0,[234,366,971,23,744],function(){return e(e.s=8678)}),_N_E=e.O()}]);