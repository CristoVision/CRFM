"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[366],{495:function(e,t,r){r.d(t,{z:function(){return u}});var a=r(7437),s=r(2265);let i=e=>"ghost"===e?"du-button ghost":"quick"===e?"du-button du-quick":"du-button",u=(0,s.forwardRef)((e,t)=>{let{variant:r="solid",full:s,className:u,...o}=e;return(0,a.jsx)("button",{ref:t,className:"".concat(i(r)).concat(s?" du-btn-full":""," ").concat(null!=u?u:""),...o})});u.displayName="Button"},9135:function(e,t,r){r.d(t,{A:function(){return s}});var a=r(7437);function s(e){let{children:t,className:r,style:s,variant:i}=e;return(0,a.jsx)("span",{className:["du-tag","ghost"===i?"du-tag--ghost":null,r].filter(Boolean).join(" "),style:s,children:t})}},857:function(e,t,r){r.d(t,{H:function(){return o},a:function(){return n}});var a=r(7437),s=r(2265),i=r(1180);let u=(0,s.createContext)({userId:null,status:"loading",signOut:async()=>{}});function o(e){let{children:t}=e,r=(0,i.O)(),[o,n]=(0,s.useState)(null),[l,d]=(0,s.useState)(r?"loading":"signed_out"),[c,_]=(0,s.useState)(void 0);(0,s.useEffect)(()=>{if(!r){d("signed_out");return}let e=!1;(async()=>{var t;let{data:a,error:s}=await r.auth.getSession();if(!e){if(s){try{await r.auth.signOut()}catch(e){}d("signed_out"),_(s.message),n(null)}else(null===(t=a.session)||void 0===t?void 0:t.user)?(n(a.session.user.id),d("ready")):d("signed_out")}})();let{data:t}=r.auth.onAuthStateChange((e,t)=>{(null==t?void 0:t.user)?(n(t.user.id),d("ready")):(n(null),d("signed_out"))});return()=>{e=!0,null==t||t.subscription.unsubscribe()}},[r]);let p=async()=>{r&&(await r.auth.signOut(),n(null),d("signed_out"))};return(0,a.jsx)(u.Provider,{value:{userId:o,status:l,error:c,signOut:p},children:t})}function n(){return(0,s.useContext)(u)}},931:function(e,t,r){r.d(t,{A:function(){return l},O:function(){return n}});var a=r(7437),s=r(2265),i=r(371),u=r(1180);let o=(0,s.createContext)({battle:{mode:"idle",log:[]},startBattle:()=>{},addLog:()=>{},reset:()=>{},tutorial:{status:"not_started"},setStarterChoice:()=>{},updateTutorial:()=>{},startTutorial:()=>{},completeTutorial:()=>{},skipTutorial:()=>{},restartTutorial:()=>{},awardXp:async()=>{},recordBattle:async()=>{},awardStageAndXp:async()=>{}});function n(e){let{children:t}=e,{playerCreatures:r,profile:n,reload:l,playerStats:d}=(0,i.G)(),c=(0,u.O)(),[_,p]=(0,s.useState)({mode:"idle",log:[]}),[f,g]=(0,s.useState)({status:"not_started",step:0}),[m,v]=(0,s.useState)(!1),y=(0,s.useMemo)(()=>(null==n?void 0:n.id)?"du:tutorial:".concat(n.id):null,[null==n?void 0:n.id]);(0,s.useEffect)(()=>{var e,t,r,a;if(!(null==n?void 0:n.id))return;let s=d.find(e=>"tutorial"===e.stat_key);if(null==s?void 0:null===(e=s.stat_value)||void 0===e?void 0:e.status){g({status:s.stat_value.status,starterChoice:s.stat_value.starterChoice,starterPool:s.stat_value.starterPool,captureChoice:s.stat_value.captureChoice,starterSex:s.stat_value.starterSex,captureSex:s.stat_value.captureSex,npcSex:s.stat_value.npcSex,npcChoice:s.stat_value.npcChoice,step:null!==(t=s.stat_value.step)&&void 0!==t?t:0,rewardClaimed:null!==(r=s.stat_value.rewardClaimed)&&void 0!==r&&r}),v(!0);return}if(!y)return;let i=localStorage.getItem(y);if(i)try{let e=JSON.parse(i);g({...e,step:null!==(a=e.step)&&void 0!==a?a:0})}catch(e){g({status:"not_started",step:0})}else g({status:"not_started",step:0});v(!0)},[y,null==n?void 0:n.id,d]),(0,s.useEffect)(()=>{y&&m&&localStorage.setItem(y,JSON.stringify(f))},[f,y,m]),(0,s.useEffect)(()=>{m&&(null==n?void 0:n.id)&&c&&(async()=>{await c.from("player_stats").upsert({user_id:n.id,stat_key:"tutorial",stat_value:f},{onConflict:"user_id,stat_key"})})()},[f,m,null==n?void 0:n.id,c]);let h=async(e,t)=>{c&&(null==n?void 0:n.id)&&e&&(await c.from("player_creatures").update({current_xp:t}).eq("user_id",n.id).eq("creature_id",e),await l())},S=async e=>{let{winner_id:t,battle_log:r}=e;c&&(null==n?void 0:n.id)&&(await c.from("battles").insert({player1_id:n.id,player2_id:"npc",winner_id:t,battle_log:r}),await l())},x=async e=>{var t,r,a;let{creatureId:s,xpGain:i}=e;if(!c||!(null==n?void 0:n.id)||!s)return;let{data:u,error:o}=await c.from("player_creatures").select("current_stage_id, current_xp, creature_id, level").eq("user_id",n.id).eq("creature_id",s).maybeSingle();if(o||!u)return;let{data:d}=await c.from("creature_stages").select("id, creature_id, stage_order, xp_required").eq("creature_id",u.creature_id),_=(d||[]).sort((e,t)=>{var r,a;return(null!==(r=e.stage_order)&&void 0!==r?r:0)-(null!==(a=t.stage_order)&&void 0!==a?a:0)}),p=_.find(e=>e.id===u.current_stage_id),f=p?_.find(e=>{var t,r;return(null!==(t=e.stage_order)&&void 0!==t?t:0)===(null!==(r=p.stage_order)&&void 0!==r?r:0)+1}):void 0,g=(null!==(t=u.current_xp)&&void 0!==t?t:0)+i,m=u.current_stage_id,v=null!==(r=u.level)&&void 0!==r?r:1;f&&null!==f.xp_required&&void 0!==f.xp_required&&g>=f.xp_required&&(g-=f.xp_required,m=f.id,v=(null!==(a=null==p?void 0:p.stage_order)&&void 0!==a?a:1)+1),await c.from("player_creatures").update({current_xp:g,current_stage_id:m,level:v}).eq("user_id",n.id).eq("creature_id",s),await l()};return(0,a.jsx)(o.Provider,{value:{battle:_,startBattle:e=>{p({mode:e,log:["Starting ".concat(e," battle with ").concat(r.length," domesticated creatures")]})},addLog:e=>p(t=>({...t,log:[...t.log,e]})),reset:()=>p({mode:"idle",log:[]}),tutorial:f,setStarterChoice:e=>g(t=>({...t,starterChoice:e})),updateTutorial:e=>g(t=>({...t,...e})),startTutorial:()=>{g(e=>({...e,status:"in_progress"})),p({mode:"trainer",log:["Tutorial iniciado"]})},completeTutorial:()=>g(e=>({...e,status:"completed"})),skipTutorial:()=>g(e=>({...e,status:"completed"})),restartTutorial:()=>{g({status:"not_started",step:0}),p({mode:"idle",log:[]})},awardXp:h,recordBattle:S,awardStageAndXp:x},children:t})}function l(){return(0,s.useContext)(o)}},371:function(e,t,r){r.d(t,{G:function(){return l},U:function(){return n}});var a=r(7437),s=r(2265),i=r(1180),u=r(857);let o=(0,s.createContext)({regions:[],creatures:[],creatureStages:[],playerCreatures:[],regionCreatures:[],cityCreatures:[],missions:[],missionProgress:[],achievements:[],userAchievements:[],bonds:[],battles:[],profile:null,trainerStats:[],playerStats:[],xpThresholds:[],factions:[],cities:[],status:"idle",isLive:!1,reload:async()=>{}});function n(e){let{children:t}=e,r=(0,i.O)(),{userId:n,status:l}=(0,u.a)(),[d,c]=(0,s.useState)("idle"),[_,p]=(0,s.useState)(void 0),[f,g]=(0,s.useState)([]),[m,v]=(0,s.useState)([]),[y,h]=(0,s.useState)([]),[S,x]=(0,s.useState)([]),[w,b]=(0,s.useState)([]),[q,C]=(0,s.useState)([]),[k,T]=(0,s.useState)([]),[j,O]=(0,s.useState)([]),[E,N]=(0,s.useState)([]),[P,A]=(0,s.useState)([]),[B,I]=(0,s.useState)([]),[J,L]=(0,s.useState)([]),[X,D]=(0,s.useState)([]),[G,M]=(0,s.useState)(null),[R,U]=(0,s.useState)(!1),[z,F]=(0,s.useState)([]),[H,K]=(0,s.useState)([]),[Q,V]=(0,s.useState)([]),[W,Y]=(0,s.useState)([]),Z=async()=>{if(!r||!n){c("idle"),U(!1);return}c("loading"),p(void 0);let e=[],[t,a,s,i,u,o,l,d,_,f,m,y,S,w,q,k,j,E]=await Promise.all([r.from("profiles").select("*").eq("id",n).maybeSingle(),r.from("creatures").select("id, name, name_locales, base_type, region, image_url, is_starter, rarity, sexes"),r.from("creature_stages").select("id, creature_id, stage_name, stage_order, stage_stats, image_url, image_url_male, image_url_female, variant_type, xp_required"),r.from("player_creatures").select("user_id, creature_id, current_stage_id, nickname, variant_type, date_caught, custom_stats, current_xp, level, in_party, party_slot, is_domesticated, stats, sex").eq("user_id",n),r.from("regions").select("id, name, color, island, municipalities, map_polygon"),r.from("region_creatures").select("region_id, creature_id, spawn_rate"),r.from("cities").select("id, name, region_id"),r.from("city_creatures").select("city_id, creature_id, spawn_rate"),r.from("story_missions").select("id, title, description, region_id, order_in_story, unlock_requirements, reward_cc, reward_item, mission_difficulty, is_battle, trainer_id"),r.from("player_mission_progress").select("user_id, mission_id, is_completed, completed_at, completion_date, rewards").eq("user_id",n),r.from("achievements").select("id, name, description, icon_url, criteria_json, reward_cc, reward_item"),r.from("user_achievements").select("id, user_id, achievement_id, achievement_name, description, date_earned, unlocked_at, notified_followers, track_id").eq("user_id",n),r.from("player_faction_bonds").select("user_id, faction, bond_amount").eq("user_id",n),r.from("battles").select("player1_id, player2_id, winner_id, battle_log, started_at, ended_at").or("player1_id.eq.".concat(n,",player2_id.eq.").concat(n)),r.from("player_trainer_stats").select("user_id, trainer_id, wins, losses, familiarity, last_battle_at").eq("user_id",n),r.from("player_stats").select("user_id, stat_key, stat_value").eq("user_id",n),r.from("creature_stage_xp_thresholds").select("id, creature_id, stage_id, xp_required, created_at, updated_at"),r.from("factions").select("id, name, description, color_hex, icon_url, slug, motto, alignment, lore_json")]),P=(t,r)=>{if(!r)return;let a="string"==typeof(null==r?void 0:r.message)?r.message:String(r);e.push("".concat(t,": ").concat(a))};P("profiles",t.error),P("creatures",a.error),P("creature_stages",s.error),P("player_creatures",i.error),P("regions",u.error),P("region_creatures",o.error),P("cities",l.error),P("city_creatures",d.error),P("story_missions",_.error),P("player_mission_progress",f.error),P("achievements",m.error),P("user_achievements",y.error),P("player_faction_bonds",S.error),P("battles",w.error),P("player_trainer_stats",q.error),P("player_stats",k.error),P("creature_stage_xp_thresholds",j.error),P("factions",E.error),t.data&&M(t.data),a.data&&h(a.data),s.data&&x(s.data.map(e=>{var t;return{...e,stage_stats:"string"==typeof e.stage_stats?JSON.parse(e.stage_stats):null!==(t=e.stage_stats)&&void 0!==t?t:{hp:0,atk:0,def:0,speed:0,faith:0}}})),i.data&&b(i.data),u.data&&g(u.data),o.data&&C(o.data),l.data&&v(l.data),d.data&&T(d.data),_.data&&O(_.data),f.data&&N(f.data),m.data&&A(m.data),y.data&&I(y.data),S.data&&L(S.data),w.data&&D(w.data),q.data&&F(q.data),k.data&&K(k.data),j.data&&V(j.data),E.data&&Y(E.data),U(!0),e.length?(c("error"),p(e.join(" | "))):c("ready")};(0,s.useEffect)(()=>{"ready"===l&&Z()},[l,n]);let $=(0,s.useMemo)(()=>({regions:f,creatures:y,creatureStages:S,playerCreatures:w,regionCreatures:q,cityCreatures:k,missions:j,missionProgress:E,achievements:P,userAchievements:B,bonds:J,battles:X,profile:G,trainerStats:z,playerStats:H,xpThresholds:Q,factions:W,cities:m,status:d,error:_,isLive:R,reload:Z}),[f,y,S,w,q,j,E,P,B,J,X,G,z,H,Q,W,d,_,R]);return(0,a.jsx)(o.Provider,{value:$,children:t})}function l(){return(0,s.useContext)(o)}},1180:function(e,t,r){r.d(t,{O:function(){return i}});var a=r(3234);let s=null;function i(){if(s)return s;let e="https://npdklestjuejrotjtqwt.supabase.co",t="sb_publishable_9xEllkhUFl85xTTXtDDT5g_ei508t0r";return e&&t?s=(0,a.eI)(e,t,{auth:{persistSession:!0,autoRefreshToken:!0}}):null}}}]);