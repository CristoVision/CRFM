# MASTER Log (organizado por proyecto/tema)

## CRFM — Webapp, Admin, Analytics
| Fecha | Agente | Resumen | Alcance/Archivos | Notas | Estado | Siguientes |
| --- | --- | --- | --- | --- | --- | --- |
| 2025-12-17T00:00:00Z | Codex | Recovery Supabase (nuevo proyecto) + monetization UX + bootstrap DB/migrations | `src/components/creator/CreatorBillingPanel.jsx`, `src/pages/Hub/HubPage.jsx`, `src/contexts/{AuthContext.jsx,authContext/*}`, `src/components/{auth/SignUpForm.jsx,profile/EditProfileForm.jsx}`, `index.html`, `.github/workflows/deploy_hostinger.yml`, `.env.production`, `bootstrap_new_supabase_project.sql`, `supabase/migrations/*` | **Causa:** proyecto Supabase previo pausado ⇒ DNS/REST/Storage caído. **Acciones:** 1) Billing: selector de método (Stripe vs CrossCoins) para compra de créditos por upload y soporte `payment_method` param. 2) Deploy Hostinger: build usa `.env.production` (nuevo `VITE_SUPABASE_URL=https://npdklestjuejrotjtqwt.supabase.co` + `VITE_SUPABASE_ANON_KEY=sb_publishable_...`) y se eliminaron hardcodes al Supabase viejo (logos/CC icons) para que el sitio al menos cargue sin Storage. 3) DB: migraciones para base mínima + RLS: trigger `profiles` on signup + backfill (para users creados antes del trigger), leaderboards RPCs (`get_top_*_leaderboard`), tabla `favorites`, y buckets/policies de Storage (requiere verificar que se aplicó en el proyecto). 4) Signup/profile: se evitó “freeze” en signup cuando email confirmation está activo (no hay session todavía), y se cambió nombre a partes (`first_name/middle_name/last_name/second_last_name`) con `full_name` derivado en DB. 5) Fixes de migraciones: reemplazo `uuid_generate_v4()` por `gen_random_uuid()`, `pg_policies.policyname`, y helper `is_admin_uid()`. **Observado en vivo:** ya se logra crear user y profile (UID admin reportado), pero el app logueado aún rompe por endpoints/tablas faltantes y select mismatch. | IN PROGRESS (sitio levanta pero faltan tablas/RPCs) | 1) Confirmar despliegue a Hostinger es el último commit (Actions green) y que el build usa `.env.production`; 2) Re-aplicar migraciones en el proyecto nuevo (en especial `storage_buckets_and_policies`, `favorites`, name parts) con `git pull` + `supabase db push`; 3) Completar schema/RPCs que hoy produce 404/400: `content_view_events`, `creator_tag_requests`, `content_flags`, `projects`, `apps`, `games`, `stations`, `ads`, `support_cases`, `creator_store_*` y RPC `get_overall_stats_for_creator`; 4) Corregir 400 en `tracks/albums/playlists/videos` (faltan columnas respecto a selects del frontend) agregando columnas o reduciendo selects; 5) Storage: recrear buckets esperados y subir assets públicos (`logo/crfm-logo-gold.gif`, `logo/CrossCoins2025.png`) + policies para uploads (evitar 400 en imágenes/audio); 6) Perfil: ampliar UI/DB para campos seguros (country, birth_date, gender, phone, etc.) y asegurar que Profile page muestra/edita correctamente; 7) Re-deploy Edge Functions + secrets Stripe en el nuevo proyecto. |
| 2025-12-16T12:00:00Z | Gemini | Integración pagos Stripe (embedded) + Corrección bugs modales + Fix despliegue CI | `workspace/CRFM/**/*`, `supabase/functions/stripe-create-payment-intent/index.ts`, `src/components/wallet/CheckoutForm.jsx`, `src/components/wallet/WalletActionModal.jsx`, `src/pages/Hub/HubPage.jsx`, `src/components/hub/LrcEditorModal.jsx`, `src/components/hub/EditAlbumModal.jsx`, `package-lock.json`, `.gitignore` | **Integración de Pagos Stripe (UI Incrustada):** Modificación de Edge Function `stripe-create-payment-intent` para `PaymentIntents`. Implementación frontend (`CheckoutForm.jsx`, `WalletActionModal.jsx`) con `PaymentElement` para experiencia "Añadir Fondos" limpia. Soporte ATH Móvil y otros métodos automáticos de Stripe. Configuración `VITE_STRIPE_PUBLISHABLE_KEY`. Revisión funcionalidad "Retirar Fondos". **Correcciones de Funcionalidad y UI de Modales:** Error de props (`onClose` -> `onOpenChange`) en `HubPage.jsx` para `CreateTrackModal`, `CreateAlbumModal`, `CreatePlaylistModal`, `LrcEditorModal`. Arreglo visual de `LrcEditorModal` (encabezado, botones sin superposición, botón de cerrar manual). Botón "Cancel" de `EditAlbumModal` cierra correctamente. **Arreglos de Git y Pipeline:** Resolución error `npm ci` regenerando `package-lock.json`. Añadido `.vscode/` a `.gitignore`. Establecido flujo `git add`, `commit`, `push`. | COMPLETED (code is pushed) | 1) **Verificar Despliegue:** Confirmar que el último commit (`4d3bdd6`) se despliega correctamente en GitHub Actions. 2) **Testear UI:** Probar funcionalidad de todos los modales afectados y el flujo de "Añadir Fondos" (incluido ATH Móvil) en el sitio en vivo/preview. 3) Limpiar caché de navegador/CDN. |
| 2025-12-15T16:20:00Z | Codex | Stripe (top-ups + subs + upload fees) + royalties por policy + collaborators | workspace/CRFM/stripe_wallet.sql, workspace/CRFM/stripe_creator_billing.sql, workspace/CRFM/stream_royalties.sql, workspace/CRFM/supabase/functions/{stripe-create-checkout-session,stripe-create-subscription-checkout-session,stripe-create-upload-fee-checkout-session,stripe-webhook}/index.ts, workspace/CRFM/supabase/functions/_shared/cors.ts, workspace/CRFM/src/components/wallet/WalletActionModal.jsx, workspace/CRFM/src/pages/WalletPage.jsx, workspace/CRFM/DEPLOY.md | Implementación Stripe via Supabase Edge Functions: top-up con monto libre (min/max USD), webhook con firma + idempotencia (tablas `stripe_events`, `stripe_topups` + RPC `rpc_apply_stripe_topup`). Añadí flows de creators: checkout de suscripción (monthly/6m/yearly) y checkout de fees por upload (track/album) con `price_...` configurables; webhook procesa `checkout.session.completed` y `customer.subscription.*`, aplica RPCs y actualiza `profiles.creator_upload_policy`. Royalties por stream: reemplacé `start_or_resume_stream` para cobrar una vez por sesión, aplicar 10% fee solo en `free`, repartir pool por `content_contributions` (100% requerido; faltante se asigna a uploader), y acreditar `withdrawable_balance`. | IN PROGRESS | 1) Ejecutar SQL en Supabase: `stripe_wallet.sql`, `stripe_creator_billing.sql`, `stream_royalties.sql`; 2) Set Supabase Edge secrets (Stripe keys, Service Role, min/max, price IDs) y desplegar functions; 3) En Stripe Webhooks: habilitar eventos `checkout.session.completed`, `customer.subscription.updated`, `customer.subscription.deleted` al endpoint de Supabase; 4) Conectar UI de Creator Hub para disparar checkout al elegir `subscription`/`pay_per_upload` y consumir `creator_upload_fee_credits`; 5) Definir withdrawals (solo creators) usando `withdrawable_balance` + hold, y Stripe Connect si se automatiza. |
| 2025-12-15T13:15:00Z | Codex | Deploy CRFM a Hostinger (auto) + versión visible | workspace/CRFM/.github/workflows/deploy_hostinger.yml, workspace/CRFM/public/.htaccess, workspace/CRFM/src/lib/buildInfo.js, workspace/CRFM/src/pages/AboutPage.jsx, workspace/CRFM/src/components/hub/HubMusicVideosTab.jsx, workspace/CRFM/DEPLOY.md | Se configuró GitHub Actions para compilar (Vite) y subir `dist/` a Hostinger por FTP con clean-slate; se añadieron envs de build (SHA/time/version) para mostrar `vX.Y.Z (sha)` en About; fix de import case-sensitive (`ContributionModal`) para que build funcione en Linux. | OK | 1) Crear secrets FTP y Supabase en GitHub Actions; 2) Para bump de versión: `npm version patch|minor|major` antes de push; 3) (Opcional) automatizar SemVer con Conventional Commits + release tooling. |
| 2025-12-13T18:10:00Z | Codex | CRFM — Monetization: upload policies persistentes + tienda descargas (privada) | workspace/CRFM/upload_policies.sql, workspace/CRFM/digital_downloads_store.sql, workspace/CRFM/src/components/creator/{CreatorMonetizationTab,CreatorUploadPreferences,CreatorDownloadsManager}.jsx, workspace/CRFM/src/components/formUtils.js, workspace/CRFM/MASTER.md | Se clarificó policy activa (badge “Active”), fee contextual (10% solo para Free), y asignación por-item (tracks/albums/videos). Se agregó scaffolding “Digital Downloads Store” para creadores: productos (track/album/video), formatos con pricing CC, expiración opcional, y códigos de descuento creados por el creador. Backend: tablas + RLS + RPC `purchase_download_format` y policies Storage para bucket privado `downloads`; billing_events extiende `event_type` con `download_purchased` para analytics. Se reemplazó el panel “Membership tiers” del hub por la nueva tienda. | IN PROGRESS | 1) En Supabase: ejecutar `upload_policies.sql` + `digital_downloads_store.sql` y crear bucket privado `downloads`; 2) UI comprador: botón “Buy download” en Track/Album/Video details + flujo de descarga (signed URL); 3) Reconciliar `billing_events` CHECK si hay constraint distinto en tu proyecto; 4) Definir fee CRFM para descargas + payout/royalty split. |
| 2025-12-13T16:45:00Z | Codex | CRFM — UI: tiers + historial membresías/códigos + upload policy | workspace/CRFM/src/pages/Hub/HubPage.jsx, src/components/creator/{CreatorMonetizationTab,CreatorTiersManager,CreatorUploadPreferences}.jsx, src/pages/ProfilePage.jsx, src/components/profile/MembershipsAndCodesTab.jsx, MASTER.md | Se agregó tab “Monetization” en Creator Hub para crear/editar/desactivar tiers y escoger política de uploads (con nota 10% fee). En Profile: vista “Memberships & Codes” con filtros (billing_events). | OK | 1) Aplicar `workspace/CRFM/upload_policies.sql` en Supabase; 2) Definir precio “pay per upload” y reglas por tipo (tracks/albums/videos); 3) (Opcional) en Hub, marcar contenido que requiera selección por-item al cambiar policy. |
| 2025-12-11T00:00:00Z | Codex | CRFM — Wallet admin UX + auditoría + soporte | workspace/CRFM/src/pages/AdminPage.jsx, src/components/admin/AdminUserManagementTab.jsx, src/components/admin/WalletAdminTab.jsx, src/components/admin/ManageFundsModal.jsx, wallet_actions.sql, admin_audit_logs.sql, support_cases.sql, SUPABASE_WALLET.md, MASTER.md | UI Users tab mobile-friendly, remove funds button (solo Wallet Admin), balances CC/USD toggle; auditoría admin_audit_logs; scripts Supabase para wallet_actions, audit logs, support cases/messages, RPCs admin_* y support; doc SUPABASE_WALLET. | OK | 1) Aplicar support_cases.sql + wallet_actions.sql + admin_audit_logs.sql en Supabase; 2) Conectar UI a RPCs de bloqueo/MFA/reset/soporte; 3) Crear tab Audit Logs y soporte en frontend. |
| 2025-12-14T00:00:00Z | Codex | CRFM — Hardening admin/HUB + env seguro | workspace/CRFM/src/**/*, docs/SUPABASE_RPCS.md | Protegí /admin y tabs con profile.is_admin; admin UI usa RPCs `rpc_admin_update_user_password`, `rpc_admin_adjust_wallet`, `rpc_admin_upsert_ad`, `rpc_admin_upsert_station`; quité hardcodes Supabase (.env local) y documenté RPCs nuevos/policy stream_cost. | TODO | 1) Ajustar deletes ads/estaciones a RPC/RLS; 2) Crear RPCs de analytics (`get_top_albums_by_creator`, `get_top_playlists_by_creator`) o reusar leaderboards; 3) Planificar automatización flags/licensing/AI copilotos; 4) Flujos monetización CrossCoins. |
| 2025-12-08T00:00:00Z | Codex | CRFM webapp: video cover art + UX fixes (About/Admin) | workspace/CRFM/src/**/*, public/site.webmanifest | Video cover art en player/portadas; focus/toasts; manifest/favicons; About/Admin con tabs responsivas. Deshabilité RPCs inexistentes (achievements) y dejé mensajes informativos en analytics cuando faltan vistas/RPC. | WARN | Backend pendientes: crear RPC `get_top_albums_by_creator`, `get_top_playlists_by_creator`, vista `daily_page_views`; añadir `track_id` a `stream_events` si se loguean streams; crear RPCs de achievements (feed/notifs) o reactivar controlador; asegurar perfil admin via role/is_admin. |
| 2025-11-16T23:30:00Z | Codex | CRFM webapp: reorganización + playback/billing fixes | workspace/CRFM/src/**/*, workspace/CRFM/vite.config.js, Desktop/CRFM Nov 2025 import script | Reorganizé app (alias @, slider UI, lrc editor), reparé QueueContext/PlayerContext, tabs/detalles de tracks, persistencia de cola, gasto de CrossCoins para videos (`spendCrossCoinsForVideo`). `npm run build` ok local. | WARNING | En host validar `npm run dev` con Album/Playlist/Track detail + ExpandedPlayer; confirmar RPC `handle_video_credit_transfer` o ajustar wallet service (cargo de videos con 1900+ CC). |
| 2025-11-16T15:30:00Z | Codex | CRFM AI integration blueprint | workspace/reports/crfm_ai_integration.md | Definí copilotos (chat cargas, mentor analytics, generador arte) con OpenAI vía Edge Functions y autoevaluación `docs/agent_rubric.yaml`. | OK | Prototipar endpoints `ai_creator_copilot`, `<AiChatDock>` con métricas/registros Supabase. |
| 2025-12-13T00:00:00Z | Codex | CRFM — Registro central de RPCs Supabase | docs/SUPABASE_RPCS.md, MASTER.md | Registro compartido de RPCs (usados/faltantes/propuestos) para reemplazar edge functions/admin writes. | TODO | Crear/ajustar RPCs propuestos y actualizar frontend con checks admin. |
| 2025-11-09T21:30:00Z | Codex | Refine Génesis 2 translation & evaluation | translations/es/genesis_2.md, evaluations/gn-2-summary.md | Correcciones sugeridas (puntuación 2:12, matiz “ayuda” 2:18, verbo “tendría” 2:19) y actualización en resumen de evaluación. | OK | Revisar Génesis 3 con mismo flujo de cotejo. |

### CRFM — Merge & Deploy Guardrails (para proyectos combinados)
- **Raíz única:** Todo merge debe aterrizar dentro de `workspace/CRFM/` sin crear subcarpetas nuevas en el hosting (`public_html/public_html` es un error).
- **Deploy target correcto:** `HOSTINGER_FTP_SERVER_DIR` debe apuntar a `/public_html` (no a `/public_html/public_html`).
- **Clean-slate controlado:** Si hay mezcla previa en Hostinger, mover/limpiar contenido y re‑deploy con `dangerous-clean-slate: true` desde CI para que quede exactamente como `dist/`.
- **Commit clarity:** Usa commits separados para cada “sub‑proyecto” (ej. `feat: add bible tab`, `feat: add du stories`) y evita mezclar cambios de infraestructura en esos mismos commits.
- **Contenido agregado:** Archivos nuevos deben ir bajo `src/` o `public/` del proyecto primario. Si se incorpora un repo externo, copiar únicamente los artefactos necesarios y documentar su origen en `MASTER.md`.
- **Validación previa:** Verificar `npm run build` local y confirmar que `dist/.htaccess` existe antes de desplegar.

### CRFM — Monetización (borrador de producto)
- CRFM retiene 10% de todas las regalías antes de withdrawal.
- Upload policies para creadores (selección en Hub):
  - `free`: se puede cambiar en cualquier momento; si hay contenido ya subido, el Hub debe guiar a asignar una opción para su contenido (singles/tracks, albums, videos) cuando aplique.
  - `pay_per_upload`: subir singles/tracks uno a la vez pagando una sola vez (precio TBD). Regalías 100% al creador permanentemente (o hasta remover el contenido de la plataforma).
  - `subscription`: cargas ilimitadas via membresía (mensual / anual / cada 6 meses con descuentos). Regalías 100% al creador hasta la fecha de vencimiento de la membresía antes del withdrawal; si expira, el contenido no se borra de inmediato pero se pierde toda regalía generada mientras permanezca en plataforma con membresía expirada.

### CRFM — Progreso de esta sesión (2025-12-13)
- Hecho: policy default por creador + policy por-item persistibles en DB (`profiles.creator_upload_policy`, `tracks/albums/videos.upload_policy`) y UI para asignación masiva por contenido.
- Hecho: tienda base de descargas digitales con control privado (entitlements), descuento por creador, RPC compra (`purchase_download_format`) y registro en `billing_events` (`download_purchased`) para analytics.
- Pendiente: UI comprador (compra + descarga), UI de analytics para creadores (ventas/formatos/códigos), y decisión final de fee CRFM/royalty split para descargas.

## DU TCG PR
| Fecha | Agente | Resumen | Alcance/Archivos | Notas | Estado | Siguientes |
| --- | --- | --- | --- | --- | --- | --- |
| 2025-12-02T00:00:00Z | Codex | DU TCG PR – regresiones severas en batalla/home | /Users/cristovision/du-tcg-pr/app/(du)/*, contexts/BattleContext.tsx, components/battle/BattleHub.tsx, app/(du)/home/page.tsx | Build roto (syntax BattleContext/home), home muestra 0s logueado, batalla sin imágenes correctas, Encounter/Trainer invertidos, sin modal victoria ni persistencia estable; captura/domesticación y cambio de criatura frágiles. | WARNING | Arreglar build TSX, restaurar login+datos en home, fijar imágenes por creature_id, corregir modos/enemigos/persistencia batallas/XP, añadir modal post-batalla y equipo de 6 + captura sin placeholders. |
| 2025-12-01T00:00:00Z | Codex | DU TCG PR – sesión incompleta (home/batalla/mapa) | /Users/cristovision/du-tcg-pr/app/(du)/*, contexts/GameContext.tsx, schema_v1.sql | Añadidas ciudades/city_creatures a GameContext, popups mapa, home reestilizado; regresiones: imágenes placeholder, combate sin modal, captura/party parcial, selección Encounter/Trainer frágil, login/home con datos en cero. | WARNING | Corregir BattleHub (modo limpio, equipo de 6, captura, modal post-batalla, imágenes por creature_id), reparar home, usar cities/city_creatures en Encounter. |
| 2025-11-17T00:00:00Z | Codex | DU TCG PR movido a carpeta propia | /Users/cristovision/du-tcg-pr/*, dream-ui/MASTER note | App Next standalone `du-tcg-pr`; regla: **un proyecto por directorio**. | OK | Mantener TCG en `/Users/cristovision/du-tcg-pr`; correr `npm run dev` ahí (symlink node_modules o `npm install`). |

## Dream UI / DreamUniverse
| Fecha | Agente | Resumen | Alcance/Archivos | Notas | Estado | Siguientes |
| --- | --- | --- | --- | --- | --- | --- |
| 2025-11-10T12:10:52Z | Codex | Reestilizar workspace + herramientas de edición | dream-ui/app/workspace/page.tsx, dream-ui/components/{MarkdownViewer,Sidebar}.tsx, dream-ui/app/layout.tsx | Workspace con lenguaje visual del home: nav/card/header unificado, sidebar filtrable, meta-panels en tarjetas, editor con toolbar (negrita/itálica/listas/citas/checklist), contador words/chars, footer consistente. | TODO | En host abrir `node server-local.mjs`, visitar `/workspace`, validar flujo de edición; correr `npm run test` smoke offline. |
| 2025-11-10T11:41:16Z | Codex | Fix Next build (static export) + workspace Suspense + TS config | dream-ui/app/workspace/page.tsx, dream-ui/scripts/build-static.mjs, dream-ui/tsconfig.json | `npm run build` stashea `app/api` para `output: export`, corre `next build` + `tsc`; `<Suspense>` para `useSearchParams`; tsconfig permite importar `.ts`. | OK | Ejecutar `npm run build` (genera `out/`) y `npm run test` en host tras cada cambio grande. |
| 2025-11-10T11:26:57Z | Codex | Offline Dream UI server + watcher/reindex upgrades | dream-ui/server-local.mjs, dream-ui/tests/smoke.mjs, dream-ui/README_RUN.md, dream-ui/package.json | Servidor local sirve `out/`, replica endpoints Next (file/read/save/diff/history/codex), reindex al iniciar/guardar, watcher chokidar + doc. Smoke test corre reindex previo. | WARNING | En host ejecutar `npm run build` y `npm run test` desde `dream-ui/` (sandbox bloquea). |
| 2025-11-23T00:00:00Z | Codex | DreamTwist (standalone) — power-ups, imágenes Wake/Dream, Supabase | /Users/cristovision/dreamtwist-standalone/app/page.tsx, lib/dreamtwist.ts, lib/dreamtwistSupabase.ts, app/perfil/page.tsx | Integra Supabase (auth/wallet/score), mapea gemas/power-ups a buckets wake/dream, efectos (void 3x3, wave fila+col, core 5x5), animaciones. Usa tabla `tracks` con flags `dreamtwist_*`, `dt_scores`, `wallet_transactions`. | TODO | Compactar HUD/menú, ajustar caída más lenta si se desea, validar clears 3+ con flood-fill. |

## Supabase / RPC / Infra (CRFM)
| Fecha | Agente | Resumen | Alcance/Archivos | Notas | Estado | Siguientes |
| --- | --- | --- | --- | --- | --- | --- |
| 2025-12-13T00:00:00Z | Codex | CRFM — Registro central de RPCs Supabase | docs/SUPABASE_RPCS.md, MASTER.md | Registro RPCs usados/faltantes/propuestos. | TODO | Crear RPCs faltantes y ajustar frontend. |

## Creación Chronicles / Veritas / Traducciones
| Fecha | Agente | Resumen | Alcance/Archivos | Notas | Estado | Siguientes |
| --- | --- | --- | --- | --- | --- | --- |
| 2025-11-29T15:34:04Z | Codex | Creation Chronicles rebase + Supabase-ready scaffold | workspace/projects/creation_chronicles/**/*, docs/supabase_structure_schema.md | Dump de Horizons a proyecto dedicado, capa de datos (Supabase env + fallback), timeline/detalle con evidencia, README/env example con modelo sugerido. | OK | Conectar .env.local con Supabase, crear tablas creation_events/creation_evidence, probar alta real. |

## MCP / Agent Pool / Infraestructura (Supervisor)
| Fecha | Agente | Resumen | Alcance/Archivos | Notas | Estado | Siguientes |
| --- | --- | --- | --- | --- | --- | --- |
| 2025-11-01 series | CODEx-SUPERVISOR | Scripts MCP, colas, workers, seeds, notificaciones | scripts/*.sh, agents/*, orchestrator/*, config/*.yaml, reports/* | Se creó pool, worker, preflight, seeds OHB, modos MCP/FS, scripts notify/mcp, docs README/POOL. | OK/VARIOS | Ver notas en cada entrada (aplicar queue, health check, MCP mode, etc.). |
| 2025-11-01T11:10:55Z .. 2025-11-01T16:55:27Z | CODEx-SUPERVISOR | (Detalle) ver tabla original en historico | | | | |

## Otros (Referencias, documentación)
| Fecha | Agente | Resumen | Alcance/Archivos | Notas | Estado | Siguientes |
| --- | --- | --- | --- | --- | --- | --- |
| 2025-11-16T15:45:00Z | Codex | Blueprint IA CRFM (ver reporte) | workspace/reports/crfm_ai_integration.md | Cierre de sesión IA; reanudar con copilotos. | OK | Prototipos Edge Functions IA. |
| 2025-11-10T11:26:57Z | Codex | Dream UI server-local | dream-ui/server-local.mjs, tests/smoke.mjs | Servidor offline + watcher. | WARNING | Ejecutar build/test en host. |

> Nota: Para historial detallado de infra MCP/agents (múltiples entradas del 2025-11-01), revisar la tabla original; se mantuvo intacta en esta reorganización.
